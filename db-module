
import { v4 as uuidv4 } from 'uuid';

const TASKS_KEY = 'tasks';

export const getTasks = () => {
  const tasksJson = localStorage.getItem(TASKS_KEY);
  return tasksJson ? JSON.parse(tasksJson) : [];
};

export const saveTasks = (tasks) => {
  localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
};

export const addTask = (title) => {
  const tasks = getTasks();
  const newTask = {
    id: uuidv4(),
    title,
    completed: false,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  };
  tasks.push(newTask);
  saveTasks(tasks);
  return newTask;
};

export const updateTask = (id, updatedFields) => {
  const tasks = getTasks();
  const taskIndex = tasks.findIndex((task) => task.id === id);
  
  if (taskIndex === -1) {
    throw new Error('Task not found');
  }

  const updatedTask = {
    ...tasks[taskIndex],
    ...updatedFields,
    updatedAt: new Date().toISOString(),
  };

  tasks[taskIndex] = updatedTask;
  saveTasks(tasks);
  return updatedTask;
};

export const deleteTask = (id) => {
  const tasks = getTasks();
  const filteredTasks = tasks.filter((task) => task.id !== id);
  saveTasks(filteredTasks);
};

export const toggleTaskCompletion = (id) => {
  const tasks = getTasks();
  const taskIndex = tasks.findIndex((task) => task.id === id);

  if (taskIndex === -1) {
    throw new Error('Task not found');
  }

  const updatedTask = {
    ...tasks[taskIndex],
    completed: !tasks[taskIndex].completed,
    updatedAt: new Date().toISOString(),
  };

  tasks[taskIndex] = updatedTask;
  saveTasks(tasks);
  return updatedTask;
};
    